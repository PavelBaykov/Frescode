@model dynamic

@{
    ViewBag.Title = "Projects List";
}

@section AdditionalScripts{
    <script type="text/javascript" src="assetsfinal/js/plugins/tables/datatables/datatables.min.js"></script>
    <script type="text/javascript" src="assetsfinal/js/pages/datatables_basic.js"></script>
    <script type="text/javascript" src="assetsfinal/js/plugins/forms/selects/select2.min.js"></script>

    <script>
        userId = @Html.Raw(Json.Encode(ViewBag.UserId));

        function ProjectsListViewModel() {
            var self = this;

            self.ProjectsList = ko.observableArray();
        }

        function ProjectViewModel() {
            var self = this;

            self.Id = ko.observable();
            self.Name = ko.observable();
            self.DateOfLastChange = ko.observable();
            self.ChangedBy = ko.observable();
            self.GotoChecklistsListCommand = function() {
                window.location.href = "Project/" +self.Id() + "/";
            };
            self.GotoDownloadProjectCommand = function() {
                window.location.href = "Download/" +self.Id() + "/";
            };
        }

        function getProjects(callback) {
            $.getJSON('/GetProjectsList')
                .error(function(e) {
                    if (e.status == 500 || e.status == 400) {
                        var message = 'Error ' + e.status + '\r\n' +
                            'Response: ' + e.responseText;
                        console.log(message);
                        alert(message);
                    }
                })
                .done(function(data) {
                    if ($.isFunction(callback)) {
                        callback(data);
                    }
                });
        }

        rootViewModel.MainViewModel(new ProjectsListViewModel());
        var mainViewModel = rootViewModel.MainViewModel();

        function fillViewModel(projectsList) {
            $(document).ready(function() {
                mainViewModel.ProjectsList.removeAll();
                _.each(projectsList.ProjectsList, function(project) {
                    var projectViewModel = new ProjectViewModel();
                    projectViewModel.Id(project.Id);
                    projectViewModel.Name(project.Name);
                    projectViewModel.DateOfLastChange(project.DateOfLastChange);
                    projectViewModel.ChangedBy(project.ChangedBy);
                    
                    mainViewModel.ProjectsList.push(projectViewModel);
                });
                initDataTables();
            });
        }

        getProjects(function(projects) {
            fillViewModel(projects);
        });

    </script>
}

@section Header
{
    <!-- Page header -->
    @*<div class="page-header" id="breadcrumb_view">
        <div class="page-header-content">
            <div class="page-title">
                <h3>
                    <a style="color:black">
                        <i class="icon-user position-left" style="margin-right:8px"></i>
                    </a>
                    <span class="text-semibold">Your Projects list</span>
                </h3>
                <ul class="breadcrumb breadcrumb-caret position-right">
                    <li class="active">Projects</li>
                    
                </ul>
            </div>

        </div>
    </div>*@
    <!-- /page header -->
}

<div id="main_content" class="page-content">
    <!-- Main content -->
    <div class="content-wrapper">
        <div class="panel panel-default">
            <div class="panel-body">
                <table class="table datatable-basic table-hover">
                    <thead>
                    <tr>
                        <th>Project</th>
                        <th>Last Edited</th>
                        <th>Edited by</th>
                        <th>Download</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- ko foreach: ProjectsList -->
                    <tr class="whitespace hoverhref" data-bind="click: GotoChecklistsListCommand" >
                        <td data-bind="html: Name"></td>
                        <td data-bind="html: DateOfLastChange"></td>
                        <td data-bind="html: ChangedBy"></td>
                        <td>
                            <button type="button" class="btn btn-default btn-rounded btn-xs" data-bind="click: GotoDownloadProjectCommand, clickBubble: false">
                                <i class="icon-download position-left"></i> Download
                            </button>
                        </td>
                    </tr>
                    <!-- /ko -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>